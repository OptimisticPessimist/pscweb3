# 日程調整カレンダーとシーン判定機能の提案

本ドキュメントでは、ユーザーからの要望である「カレンダーから日程調整を選べる画面と、どの日程ならどのシーンが稽古可能かの判別」のアルゴリズムおよびUIの設計案をまとめます。

## 背景と要件
現状の日程調整（SchedulePoll）では、ユーザーの出欠回答（○/△/×）を集計していますが、「結局、特定の日程で誰が集まり、どのシーンの稽古ができるのか」を直感的に把握することが難しいという課題があります。
これを解決するため、カレンダーベースのUIと、シーン参加可否の自動判定ロジックを導入します。

## アルゴリズムの設計案

### 1. 候補日程 → 稽古可能シーン の判定（正引き）
ある候補日時（`SchedulePollCandidate`）において、どのシーン（`Scene`）が稽古可能かを判定します。

**判定手順**:
1. 指定された候補日時において、回答が "ok" (または "maybe") となっている `user_id` のリスト（参加可能メンバー）を取得します。
2. そのプロジェクトの全ての `Scene` についてループを回します。
3. `SceneCharacterMapping` から、対象シーンに登場する `Character` のリストを取得します。
4. 各 `Character` について、`CharacterCasting` を確認します。その役を演じている `user_id` の**少なくとも1人**（ダブルキャストなどを想定）が「参加可能メンバー」に含まれているかを確認します。
5. 全ての必要な `Character` のキャストが揃っている場合、そのシーンは「稽古可能」と判定されます。
6. **付加価値**: もし1名だけキャストが不足している場合、「あと〇〇さんがいれば稽古可能」といった【リーチ状態】のシーン情報も出力すると、調整の際に非常に便利です。

### 2. シーン → 候補日程 の判定（逆引き）
「このシーン（例：ラストシーン）の稽古をしたいが、いつなら可能か」を判定します。

**判定手順**:
1. 上記のアルゴリズムで、各シーンが必要とする「必須ユーザーリスト」を算出しておきます。
2. 全ての日程候補についてループを回し、必須ユーザー全員が「参加可能」となっている日程を抽出します。

---

## UIの設計案

### 1. カレンダーベースの全体レイアウト
日程調整画面のメインビューを、リスト形式から**カレンダー形式（例: FullCalendarなど）**に変更します。

- **カレンダーセル上の表示**:
  日付ごとのセルに「3つの候補枠」「参加可能人数：最大5名」等のサマリーバッジを表示します。
- **直感的な操作**:
  カレンダー上の日付をクリックすると、右側にスライドするサイドパネル（または下部のドロワー）で詳細な情報を表示します。

### 2. サイドパネル（日付詳細ビュー）
日付を選択した際に表示するパネルでは、以下の情報を整理して見せます。

- **時間帯別の候補枠**: 例）18:00 - 21:00
- **参加予定メンバー一覧**: 「参加：〇〇、〇〇、〇〇」のリスト表示。
- **🟢 稽古可能なシーン**: そのメンバーだけで練習できるシーンの一覧（シーン番号、見出し）。
- **🟡 あと1人で可能なシーン**: 「シーン5（不足：山田）」のように、あと誰の予定を調整すればそのシーンができるのかを可視化します。

### 3. シーンでのフィルタリング（逆引き検索）
カレンダーの上部に「**シーンで絞り込む**」というドロップダウンメニューを配置します。
- **操作**: 演出家がプルダウンから「シーン10（クライマックス）」を選択します。
- **結果**: シーン10の稽古に必要なメンバーが全員揃っている日付だけが、カレンダー上でハイライト（強調表示）され、それ以外の日付はグレーアウトされます。

---

## User Review Required

> [!IMPORTANT]
> 以下の点について、方針のレビューと決定をお願いいたします。
> 1. **回答の扱い**: "maybe"（△）は「参加可能」とみなしてシーン判定に含めますか？（オプションで「確実に参加可能な人だけで判定」と切り替えられるようにするのも一つの手です）
はい、maybeは参加可能とみなしてシーン判定に含めます。
ただし、色などの見た目は変えてください。

> 2. **ダブルキャストの扱い**: 同じ役に複数の人が割り当てられている場合、そのうち1人でも参加できれば「稽古可能」と判定する仕様で問題ないでしょうか。
はい、問題ありません。

> 3. **「あと1人で可能」機能**: この機能は調整において有用ですが、実装に少し計算コストがかかります。初期リリースから含める方針で進めますか？
はい、含めてください。

上記の方針でよろしければ、バックエンドのAPI実装から進めてまいります。
