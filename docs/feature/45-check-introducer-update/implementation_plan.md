# [調査および修正] 予約ページの紹介者（キャスト）リスト更新不具合

## 調査結果
ユーザーからの「ユーザー追加や配役変更時にリストが更新されない」および「もしかしたら反映されているかも」というご指摘について、フロントエンド・バックエンドのコードを調査しました。

結果として、**基本的にはページ構成上、配役変更などは動的に再取得され反映されます**。しかし、バックエンドAPIに以下の**重大な不具合**が存在し、これが「リストが正しく更新されない」ように見えた原因である可能性が高いです。

1. **他プロジェクトの配役状況が混入してしまう不具合**:
   予約ページ等で呼ばれる公開API `get_project_members_public` にて、紹介者を「キャストのみ」で絞り込む際、「当該プロジェクトのキャスト」であるかの絞り込み（`project_id`でのフィルタリング）が漏れていました。
   これにより、**「他のプロジェクトで配役されているユーザー」が、現在のプロジェクトのキャスト一覧にも表示されてしまう状態**になっていました。
   （例：プロジェクトAでキャストから外しても、プロジェクトBのキャストに入っていれば、プロジェクトAの予約ページに表示され続けてしまう）

2. **「すべて」タブと「キャスト」タブの仕様について**:
   メンバーをプロジェクトに追加した直後は「キャスト」タブ（デフォルト）には表示されず、「すべて」タブに切り替えるか、配役（CharacterCasting）を設定するまでは表示されません。これも「追加したのに反映されない」という混乱を招いた要因の一つかもしれません。

## 提案する修正内容
上記1のバグを修正し、現在のプロジェクトでの配役情報のみに基づいて「キャスト一覧」をフィルタリングするようにAPIを修正します。

---

## Proposed Changes

### Backend
#### [MODIFY] backend/src/api/reservations.py
- **`get_project_members_public` APIの修正**:
  - `role == "cast"` の条件内で、`Character` と `Script` モデルをJOINし、`Script.project_id == project_id` であるものだけに厳密に絞り込むようにクエリを修正します。
- `Character`, `Script` モデルのインポート追加。

---

## Verification Plan

### 自動テスト (Automated Verification)
- Pythonの`pytest`を使用して、既存のAPIテストや予約関連のテストが壊れていないか確認します。
- コマンド: `uv run pytest backend/tests/api/test_reservations.py` など

### 手動テスト (Manual Verification)
1. 複数のプロジェクトに所属し、片方のプロジェクトでのみキャストとして配役されているユーザーを用意します。
2. 配役されていない方のプロジェクトのAPI（`/public/projects/{project_id}/members?role=cast`）を叩き、そのユーザーが含まれないことを確認します。
3. プロジェクト内で新たに配役を設定・解除し、即座にAPIの返り値が更新されることを確認します。
