# 日本語Fountain対応 実装計画

## 概要
Fountainの日本語拡張フォーマット（Fountain for Japanese）に対応するため、`fountain_parser.py` を改修する。
具体的には、標準のFountainパーサーが「Action」として認識してしまう独自の記法（一行セリフ）や、シーン見出し、キャラクター定義の挙動を調整する。

## 問題点
1. **一行セリフ**: `@キャラクター名 セリフ` の形式が `Action` としてパースされ、セリフとして認識されない。
2. **強制シーン見出し**: `.シーン名` は `Scene Heading` としてパースされるが、先頭の `.` が残る可能性がある。
3. **ト書きのインデント**: 全角スペース等でのインデントが `.strip()` によって削除されてしまう。

## 対応内容

### Backend (`src/services/fountain_parser.py`)

#### 1. Action要素の解析ロジック拡張
`element.element_type == "Action"` の処理ブロック内で以下の判定を行う。

- **一行セリフの検出**:
    - 行頭が `@` で始まる場合。
    - `@` の後に空白（半角/全角）がある場合、そこで分割。
    - 前半を「キャラクター名」、後半を「セリフ」として処理。
    - `Character` モデルの取得/作成を行い、`Line` (Dialogue) として保存。
    - `@` のみに文字が続く場合（空白なし）は、単なるキャラクター行（強制）として扱いたいが、Fountain標準ではその次行がセリフになる。しかし一行セリフ記法では空白区切りを想定。
    - URLの例: `@ピーター ピザが好きなんです。` -> `@` + `ピーター` + ` ` + `ピザ...`

- **ト書きの空白保持**:
    - 通常のActionの場合、`content` を保存する際に `.strip()` ではなく `.rstrip()` を使用し、行頭の空白（全角含む）を保持する。
    - ただし、過剰な改行は除去する。

#### 2. 強制シーン見出し（ドット記法）の階層化対応
- `.1 Title`, `.2 Title`, `.3 Title` はそれぞれ `# Title`, `## Title`, `### Title` と同等の階層構造（Section Heading）として扱う。
- `fountain_parser.py` で `Section Heading` として処理される際、`#` の数による階層判定と同様に、`.` の数（または数字）に応じた階層処理を行う。
- ただし、Fountainパーサーライブラリがこれらを `Scene Heading` として認識してしまう場合（`.`始まりの行）、それを適切なレベルの `Section Heading` （または `Scene`）にマッピングし直す必要がある。
- 現状の実装では `Section Heading` は `act_number` (Level 1) や `Scene` (Level 2/Standard) の判定に使われている。
- 修正方針:
    - `Scene Heading` または `Section Heading` のコンテンツが `.` で始まる場合:
        - `.1` または `.` (1つ) -> Level 1 (Act)
        - `.2` または `..` (2つ) -> Level 2 (Scene)
        - `.3` または `...` (3つ) -> Level 3 (Sub-scene/Section - 現状はSceneの一部として統合するか無視するか検討)
    - `.1` (Level 1) の場合は `Act` として処理。
    - `.2` (Level 2) の場合は `Scene` として処理。

## 検証計画
- `tests/verify_jp_parsing.py` を更新し、以下の項目を検証する。
    - `.1 第一幕` -> Actとして認識されるか。
    - `.2 シーン` -> Sceneとして認識されるか。
    - `@ピーター セリフ` -> ActionではなくDialogueとして認識され、Character `ピーター` が紐付いているか。
    - インデント付きト書き -> 保存されたコンテンツに行頭スペースが残っているか。
