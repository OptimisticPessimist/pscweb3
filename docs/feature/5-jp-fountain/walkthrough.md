# 日本語Fountain対応 Walkthrough

## 概要
日本語Fountain拡張フォーマット（Fountain for Japanese）の主要な機能に対応しました。
これにより、日本の脚本家が慣れ親しんだ記法で執筆したテキストを正しくパースできるようになりました。

## 対応した機能
1. **一行セリフ (`@名前 セリフ`)**
   - `@` で始まる行に空白（半角/全角）を入れてセリフを記述した場合、キャラクターとセリフとして正しく分割して認識します。
   - 例: `@ピーター ピザが好きなんです。` -> Character「ピーター」、Dialogue「ピザが好きなんです。」

2. **強制シーン見出しの階層化 (`.1`, `.2`)**
   - `.1 タイトル` を **第一階層（Section/Act）** として扱います（`#` と同等）。
   - `.2 タイトル` を **第二階層（Scene）** として扱います（`##` と同等）。
   - 見出しテキストからは先頭のドットや数字が除去され、クリーンな状態で保存されます。

3. **ト書きのインデント保持**
   - 全角スペース等で行頭をインデントした場合、そのインデントを削除せずに「ト書き (Action)」として保存します。
   - 実装詳細: パーサーの前処理で、インデントされた行（かつキャラクター行の直後でない行）を強制Action（`!`）としてマークすることで、Fountainライブラリによる空白削除を回避しています。

## 検証結果
新しく作成したユニットテスト `backend/tests/unit/test_jp_features.py` にて、以下のケースが正常に動作することを確認しました。

- `.1 第一幕` が正しくActとして認識され、シーン番号をインクリメントしないこと。
- `.2 シーン１` が正しくSceneとして認識され、DBに保存されること。
- `（ここにアクション）` や `　　全角スペースインデント...` がActionとして正しく保存され、インデントが保持されていること。
- `@ピーター 一行セリフ` がCharacterとLine(Dialogue)に分割されること。
- `@花子 (ハナコ)` のように括弧を含むキャラクター名が正しく保存されること。

## 制限事項
- **ト書きのインデント**: 直前の行がキャラクター指定（`@Name`）である場合、インデントされた行は「セリフ (Dialogue)」として扱われます（Fountain仕様準拠）。インデントされたト書きを記述する場合、キャラクター行の直後には空行を入れることを推奨します。
