# プロジェクト作成上限数の緩和機能の実装計画

ユーザーが毎月変わるパスワード（オーナーから提供）を登録することで、プロジェクト作成上限数が増加する機能を実装します。

## 概要と要件
Azure環境変数（または `.env`）からデフォルトの上限数、パスワード所持者の上限数、および対象のパスワードを読み込み、バックエンドでプロジェクト作成制限を判定します。
パスワード自体が毎月変わるため、ユーザーモデルにパスワードを保存し、プロジェクト作成時に環境変数のパスワードと照合する仕組みとします。

## 変更の概要 (Backend)

### DB設定・マイグレーション
#### [MODIFY] src/db/models.py
- `User` モデルに `premium_password` カラム (String, nullable) を追加します。

#### [NEW] alembic/versions/xxxx_add_premium_password_to_user.py
- 上記のモデル変更を反映したマイグレーションスクリプトを生成します。

### API設定
#### [MODIFY] src/schemas/auth.py (またはuserスキーマ)
- 新規追加: ユーザープロフィール更新用の `UserUpdate` スキーマ（`premium_password` を含む）。
- 既存修正: 必要に応じて `UserResponse` などにパスワード登録有無を表すフラグを含めます。

#### [MODIFY] src/services/project_limit.py
- `check_project_limit` 関数を修正。
- `DEFAULT_PROJECT_LIMIT` (例: 1), `PREMIUM_PROJECT_LIMIT_TIER1` (例: 3), `PREMIUM_PROJECT_LIMIT_TIER2` (例: 5), `PREMIUM_PROJECT_LIMIT_TEST` (例: 99) を設定から取得します。
- 環境変数として `PREMIUM_PASSWORD_TIER1`, `PREMIUM_PASSWORD_TIER2`, そして変更されないテスト用 `PREMIUM_PASSWORD_TEST` を用意します。
- 現在のユーザーの `premium_password` と設定値が一致すれば、対応するティアの上限を適用します。不一致または未設定ならデフォルト側を使用するように判定ロジックを変更します。
- **新規要件:** 現在のプロジェクト数が上限を超えている場合（例: パスワードが変わって基本上限に戻り、超過状態になった場合）、ユーザーがオーナーを務めるプロジェクトのうち、作成日時が古いものから上限数までのプロジェクトは「通常通り」とし、上限を超えた新しいプロジェクトについては**「制限モード（閲覧のみ可能で編集・追加などの機能が使えない状態）」**となるような判定ロジックまたはプロパティ（例: `is_over_limit`）を算出し、レスポンスに含めます。

#### [MODIFY] src/db/models.py またはレスポンススキーマ
- APIでプロジェクト情報を返す際（`ProjectResponse` 等）、そのプロジェクトが「制限モード」に該当するかどうかを示す `is_restricted` または `is_over_limit` などのフラグを追加します。

#### [MODIFY] src/dependencies/permissions.py または各種API (rehearsals.py, schedule_polls.py 等)
- 各種リソースの作成（POST）、更新（PUT/PATCH）、削除（DELETE）などの権限チェック（例: `get_project_editor_dep`, `get_project_owner_dep`）を行う箇所に、対象のプロジェクトが「制限モード」であるかの判定を追加します。
- 制限モードの場合、`403 Forbidden` エラーで「作成上限数を超過しているため、このプロジェクトは閲覧のみ可能です。機能を利用するにはパスワードを更新するか、プロジェクトを整理してください。」と返し、ユーザーによるデータ変更機能（UIからのアクション）の利用を制限します。
- 読み取り（GET）系のAPIはこれまでの権限（Viewer等）があればそのまま許可し、閲覧可能とします。

#### [MAINTAIN] バックグラウンド処理・バッチ処理について (function_app.py 等)
- 「制限モード」であっても、すでに登録済みのデータに対する**自動通知（リマインダー等）はシステム内部から実行されるため、制限対象外として通常通り送信される**ように維持します（DBのデータを読み取って通知するだけの部分は権限チェックを通さないため、自動的に要件を満たします）。
- UIからの明示的な発火（手動リマインド送信など）は制限されます。

## 変更の概要 (Frontend)
### UI変更
#### [MODIFY] フロントエンドの該当ページ（要特定）
- 現状、専用の設定画面がない場合は、ヘッダーのユーザーメニューやプロジェクト一覧/作成画面付近に、「設定（プレミアム パスワード）」を入力できるモーダルを追加します。
- プロジェクト一覧画面やプロジェクト作成ダイアログにおいて、現在のプロジェクト作成数と上限数（N / M）を表示し、パスワード入力へ誘導するUIを設けます。
※ フロントエンドの正確な修正対象ファイルは実装フェーズに入り次第特定して追加します。

## ユーザーへの確認事項
- 今回は「ユーザーのDBにパスワードそのものを一時記録し、プロジェクト作成時の環境変数の現在のパスワードと照合する」という設計にします。月が変わり環境変数が更新されると、以前に登録したユーザーのパスワードは不一致となり、自動的に元の制限に戻るため非常に相性が良い設計です。この方針で進めてよいでしょうか？

## テスト・検証計画

### 自動テスト
- コマンド: `pytest tests/unit/test_project_limit.py`
- 新たに「パスワードが設定されており一致する場合」と「不一致の場合」のプロジェクト作成上限数のテストケースを追加し、パスすることを確認します。

### 手動検証
1. プロジェクトをローカル環境で起動する。
2. `.env` に `DEFAULT_PROJECT_LIMIT=2`, `PREMIUM_PROJECT_LIMIT=5`, `PREMIUM_PASSWORD=secret` を設定する。
3. デフォルト状態でプロジェクトを3つ作成しようとして、3つ目でエラーになることを確認。
4. UIからパスワード `secret` を送信・保存。
5. 再度プロジェクト作成を行い、5つまで作成できることを確認。
6. 設定からパスワードを間違ったものに変更（または環境変数を変更して再起動）し、再度作成が2つの制限に戻ることを確認。
