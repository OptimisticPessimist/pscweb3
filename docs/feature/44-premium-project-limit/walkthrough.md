# Walkthrough - プレミアムプロジェクト上限機能

## 変更の概要
プレミアムパスワード（月替わり）により、プロジェクトの作成上限数を動的に変更できる仕組みを実装しました。
また、上限を超過したプロジェクトについては自動的に「閲覧のみ（制限モード）」に切り替えることで、過去のデータの閲覧は維持しつつ過剰なリソース利用を制限します。

## 主な変更点

### 1. データベース
- `User` モデルに `premium_password` カラムを追加しました。
- `TheaterProject` モデルに `created_by_id` カラムを追加しました。これにより、オーナー権限の譲渡に関わらずプロジェクト作成者（課金枠主）が一貫して判定されます。

### 2. プレミアム設定管理 (`PremiumConfigService`)
- Azure Blob Storage (`premium_settings.json`) から動的にパスワードと上限を取得する仕組みを導入しました。
- 5分間のメモリキャッシュを保持しており、Azureの環境変数（再起動が必要）に頼らずに動的な更新が可能です。

### 3. プロジェクト制限と権限チェック
- プロジェクトを作成日時順に並べ、**作成者（枠主）のプラン上限**から溢れたプロジェクトを「制限モード」として判定します。
- **オーナー権限を付与されても自分の枠は消費しません**。これにより、プレミアム会員が一般ユーザーからオーナー権限をもらっても、自身の別プロジェクトに影響が出ない（掛け持ち運用がしやすい）設計となっています。
- 制限モードのプロジェクトに対しては、`PUT`, `POST`, `DELETE` などのデータ変更を伴うAPIが `403 Forbidden` を返すように権限チェックを強化しました。
- ただし、システムによる自動通知（リマインダー）などの読み取り系バックグラウンド処理は継続して動作します。

### 5. フロントエンドUI
- **ユーザー設定画面 (`/settings`)**: プレミアムパスワードの入力・確認ができるページを新設しました。
- **制限モード通知**: プロジェクト一覧（ダッシュボード）で「制限モード」バッジを表示し、プロジェクト詳細画面では警告バナーを表示します。
- **操作制限**: 制限モード中は、プロジェクト設定の保存やメンバー招待など、データ変更に関わるボタンが表示されない、または非活性になります。

### 4. APIの拡張
- `PATCH /me`: ユーザーが自分のプレミアムパスワードを更新するためのエンドポイント。
- プロジェクト一覧・詳細: レスポンスに `is_restricted` フラグを含め、フロントエンドで制限状態を識別可能にしました。

## 確認手順
### バックエンド
1. `PATCH /api/users/me` で適当なパスワードを設定する。
2. 設定したパスワードが、Blob上の設定（または環境変数のデフォルト）の Tier 1 や Tier 2 のものと一致することを確認。
3. 制限数を超えてプロジェクトを作成しようとすると `400 Bad Request` が返ることを確認。
4. 途中でパスワードを無効なものに変更し、プロジェクト詳細を取得すると `is_restricted: true` になり、データの更新が `403 Forbidden` になることを確認。

### フロントエンド
1. サイドバーの「ユーザー設定」（歯車アイコン）から設定画面を開き、プレミアムパスワードを入力して保存。
2. ステータスが「有効」になることを確認。
3. 制限数を超えてプロジェクトを作成しようとし、バックエンドからのエラーメッセージが正しく表示されることを確認。
4. 制限モードになっているプロジェクトを開き、警告バナーの表示と設定画面等での操作制限（ボタン非表示）を確認。
