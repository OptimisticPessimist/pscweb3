# 修正内容の確認 (Walkthrough) - 脚本ト書き対応

脚本のプレビューでト書き（Stage Directions）が表示されない問題を修正しました。

## 実施した変更

### 1. データベース設定の変更
- `lines` テーブルの `character_id` を Null許容に変更しました。
- これにより、特定のキャラクターに紐付かない行（ト書き）を保存可能になりました。

### 2. バックエンド処理の更新
- **Fountainパーサー**: `Action`（ト書き）要素を検出し、キャラクターIDなしの行として保存する処理を追加しました。
- **香盤表生成**: 香盤表を作成する際、キャラクターIDがない行は無視するように修正しました（エラー回避）。
- **APIスキーマ**: `LineResponse` でキャラクター情報を任意（Optional）に変更しました。

### 3. フロントエンド表示の更新
- `ScriptDetailPage.tsx` を更新し、キャラクター情報がない行をト書きとして表示するロジックを追加しました。
  - セリフ： 右側にキャラクター名 + セリフ
  - ト書き： 左側にイタリック体で表示（全幅）

### 4. バグ修正・機能追加
- **バグ修正**: 脚本アップロード時および詳細表示時に発生していた500エラー（`MissingGreenlet`）を修正しました（リレーションのEager Loading追加）。
- **機能追加**: 脚本詳細画面の上部に「登場人物（Characters）」リストを表示するセクションを追加しました。

## 検証結果

### 自動テスト
- `tests/unit/test_fountain_parser.py` に新しいテストケースを追加し、以下の点を確認しました：
  - ト書きを含むスクリプトが正しくパースされること。
  - ト書き行の `character_id` が `None` として保存されること。
  - セリフ行は引き続き正しくキャラクターに紐付くこと。

### 手動検証手順（ユーザー実施推奨）
1. アプリケーションを起動し、ト書きを含む脚本（PDF/Fountain）をアップロードしてください。
2. 脚本詳細画面を開き、**ページ上部に登場人物一覧が表示されていること**を確認してください。
3. ト書きがセリフとは異なるスタイルで表示されていることを確認してください。
4. 香盤表画面を開き、エラーが表示されず、ト書きがキャストとしてカウントされていないことを確認してください。
