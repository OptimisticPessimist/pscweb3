# プロジェクト制限の修正とUI改善

## 概要
プロジェクト作成数の制限（公開1、非公開1）に関する問題を修正し、ダッシュボード上で公開/非公開プロジェクトを識別できるようにしました。

## 変更点

### 1. データベーススキーマの変更
- `TheaterProject` テーブルに `is_public` (BOOL) カラムを追加しました。
- 既存のプロジェクトはデフォルトで `FALSE` (非公開) に設定されます。

### 2. バックエンドロジックの変更
- **プロジェクト制限チェック**: 
  - 以前は脚本をすべて取得して公開状態を確認していましたが、`TheaterProject.is_public` カラムを直接クエリすることで高速化・簡素化しました。
  - 公開プロジェクトは作成数制限のカウント対象外としました。
- **プロジェクト作成API**:
  - `ProjectResponse` に `is_public` を含めるようにしました。
  - 公開脚本からのインポート時、作成されるプロジェクトと脚本の両方に `is_public=True` を設定するようにしました。
- **脚本アップロード/更新**:
  - 脚本の `is_public` フラグが変更されると、親プロジェクトの `TableProject.is_public` も同期されるようにしました（1プロジェクト1脚本のため）。

### 3. フロントエンド (Dashboard) の変更
- **プロジェクト一覧**:
  - `Project` 型に `is_public` を追加しました。
  - ダッシュボードのプロジェクトカードに「公開 (Public)」バッジを表示するようにしました。
- **制限ロジック**:
  - 「新規プロジェクト作成」ボタンの活性/非活性判定において、公開プロジェクトをカウントから除外するように修正しました。

### 4. 公開脚本周りの改善 (ID: 3)
- **レイアウトの統一**:
  - `/public-scripts` および `/manual` ページにもサイドバーとヘッダー（ログイン時はユーザー情報含む）を表示するように `App.tsx` を構成変更しました。
- **公開脚本からのプロジェクト作成**:
  - 公開脚本詳細ページに「この脚本でプロジェクトを作成」ボタンを追加しました。
  - ボタンを押すとダッシュボードのプロジェクト作成モーダルが開き、脚本名が自動入力されます。
  - **制限**: 帰属保護のため、インポート時は「公開プロジェクトにする」設定が強制的に無効（非公開）になります。
  - 作成時、バックエンドで自動的に脚本内容がコピーされ、シーン解析（Synchronous）が行われます。

### 5. バグ修正 (ID: 5)
- **バックエンドImport Error修正**:
  - プロジェクト作成時のスクリプト解析処理において、存在しないクラス `ScriptProcessor` をインポートしようとしていたため、`parse_and_save_fountain` 関数の直接呼び出しに修正しました。

### 6. バグ修正 (ID: 6)
- **公開バッジが表示されない問題修正**:
  - プロジェクト一覧取得API (`list_projects`) のレスポンス構築時に `is_public` フィールドが欠落していたため、これを含めるように修正しました。

### 7. UI改善 (ID: 7)
- **招待リンクの使用回数表示**:
  - 招待リンク生成パネル (`InvitationPanel`) において、最大使用回数が設定されている場合、「使用回数: X / Max」を表示するようにしました。これにより、制限が機能していることを視覚的に確認できるようになります。

### 8. 権限修正 (ID: 8)
- **脚本アップロード権限の厳格化**:
  - `viewer` (閲覧者) 権限のユーザーが脚本をアップロードできないように、バックエンド (`ScriptProcessor.validate_upload_request`) にロールチェックを追加しました。
  - `owner` または `editor` 権限のみがアップロード可能です。

## 検証結果

### 自動テスト
- `backend/src/services/project_limit.py` のロジック変更により、DB操作が効率化されました。
- `backend/src/api/projects.py` の変更により、インポート時の公開設定が正しく適用されます。

### 手動検証手順 (ユーザー実施)
1. **ダッシュボード確認**:
   - 既存のプロジェクトが表示されているか確認。
   - 公開プロジェクトがあれば「公開」バッジがついているか確認。
2. **プロジェクト作成（制限内）**:
   - 非公開プロジェクトが2つ未満の場合、新規作成できるか確認。
3. **プロジェクト作成（制限超過）**:
   - 非公開プロジェクトを2つ作成した後、新規作成ボタンがグレーアウトし「作成できるプロジェクトは2つまでです」と表示されるか確認。
4. **公開脚本のインポート**:
   - 公開スクリプトページから「この脚本を使う」を実行。
   - 作成されたプロジェクトに「公開」バッジがつき、制限数にカウントされていないことを確認（ボタンが有効なままか）。

## 次のステップ
- 本番環境（Azure）へのデプロイ時に、自動的にマイグレーションが適用されます。
- 万が一エラーが発生した場合は、Azureのログを確認してください（カラム追加の反映待ちなど）。
